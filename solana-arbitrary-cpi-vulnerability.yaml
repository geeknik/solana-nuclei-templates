id: solana-arbitrary-cpi-vulnerability

info:
  name: Solana Arbitrary CPI Vulnerability
  author: geeknik
  severity: high
  description: |
    Detects when a Solana program performs Cross-Program Invocation (CPI) without proper verification of the target program ID, which could allow attackers to trick the program into calling malicious code.
  remediation: |
    Always verify the program ID before making a CPI call: `if &spl_token::ID != ctx.accounts.token_program.key { return Err(ProgramError::IncorrectProgramId); }`
  reference:
    - https://github.com/slowmist/solana-smart-contract-security-best-practices
  metadata:
    verified: true
  tags: audit,solana,smart-contract,cpi,validation

file:
  - extensions:
      - rs

    matchers:
      - type: regex
        part: body
        regex:
          - "program::invoke\\("
          - "invoke_signed\\("
        condition: or
        regex:
          - "if\\s+[^{]*program_id\\.key|ID\\s*!=\\s*[^{]*\\{"
          - "require_eq\\!\\([^,]*program_id\\.key|ID"
        negative: true
        condition: or
